<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <!--Edit the title of the page-->
    <title>Central Brooklyn School Mapping Project</title>
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
    <!--[if lte IE 8]>
      <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
    <![endif]-->
    <!--Switch between the different themes changing the stylesheet below - light-theme.css |dark-theme.css -->
    <link rel="stylesheet" href="light-theme.css">
    <link rel="stylesheet" href="makeitresponsive.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>

  <!-- 
    Load Leaflet. Pretty standard.
  -->
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  
  <!-- 
    Load moment.js. This makes formatting dates easier:
      http://momentjs.com/
  -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.min.js"></script>
  
  <!-- 
    Load Leaflet.timeline. This is a Leaflet plugin that will make it possible
    to show time-based data with a slider.
      https://github.com/skeate/Leaflet.timeline
  -->
  <script src="https://cdn.rawgit.com/ebrelsford/Leaflet.timeline/remove-displayed-layers/dist/leaflet.timeline.min.js"></script>
  <link rel="stylesheet" href="https://cdn.rawgit.com/skeate/Leaflet.timeline/master/dist/leaflet.timeline.min.css"/>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>JS Bin</title>
  
     <script>
    var map;
    var timeline;
    var tractsTimeline;
        function getSchoolsStyle(data) {
      // Get the value from the census tract for
      // whatever is selected in the dropdown
      var pctValue = data.properties[$('.categorySchools').val()];
 
      var catName = $('.categorySchools').val();

      var fillOpacity;
      if (pctValue == undefined) {
        fillOpacity == 0;
      }
      console.log(catName);
      var fillHue; 
      if (catName == 'utilpct') {
        fillHue = 0;
      }
      if (catName == 'enrpctafm') {
        fillHue = 150;
      }
       if (catName == 'enrpctasi') {
        fillHue = 200;
      }
       if (catName == 'enrpcthis') {
        fillHue = 250;
      }
       if (catName == 'enrpctwht') {
        fillHue = 300;
      }
       if (catName == 'enrpctpov') {
        fillHue = 350;
      } 
       if (catName == 'ccdenrpctfrl') {
        fillHue = 350;
      }
      // Varying lightness by whatever is selected in
      // the dropdown
      
      
      var fillColor = 'hsl(' + fillHue + ', 66%, ' + (((1 - pctValue) * 88) + 10) + '%)';
      if (pctValue == undefined) {
        fillColor = 'hsl(0, 0%, 70%)';
      }
      // Varying point radii by enrnumtot

      var radius = 10;
        radius = data.properties.enrnumtot / 60;

      return {
        radius: radius,
        stroke: true,
        color: "#000",
        weight: 1,
        fillColor: fillColor,
        fillOpacity: fillOpacity
      };
    }

    function getTractsStyle(feature) {
      // Get the value from the census tract for
      // whatever is selected in the dropdown
      var pctValue = feature.properties[$('.category').val()];

      var catName = $('.category').val();

      var fillOpacity = 0.8;
      if (pctValue == undefined) {
        fillOpacity = 0;
      }
      console.log(catName);
      var fillHue; 
    
      if (catName == 'pctafm') {
        fillHue = 150;
      }
       if (catName == 'pctasi') {
        fillHue = 200;
      }
       if (catName == 'pcthis') {
        fillHue = 250;
      }
       if (catName == 'pctwht') {
        fillHue = 300;
      }
       if (catName == 'pctpov') {
        fillHue = 350;
      }
       if (catName == 'pct18') {
        fillHue = 30;
      }
      // Varying lightness by whatever is selected in
      // the dropdown
      
      var fillColor = 'hsl(' + fillHue + ', 66%, ' + (((1 - pctValue) * 88) + 10) + '%)';
      console.log(fillColor);

      if (pctValue == undefined) {
        fillColor = 'hsl(0, 0%, 70%)';
      }
      if (catName == 'numtot') {
        fillColor = 'hsl(' + fillHue + ', 66%, ' + (pctValue / 100) + '%)';
      }
      return {
        stroke: false,
        fillColor: fillColor,
        fillOpacity: fillOpacity
      };
    }

    $(document).ready(function () {
      
      /*
       * Create the map
       */
      map = L.map('map').setView([40.681503, -73.931500], 14);

      /*
       * Add base tiles from Mapbox. Replace "ebrelsford.ho06j5h0" with
       * the id from your Mapbox map to use those tiles instead.
       */
      L.tileLayer('https://{s}.tiles.mapbox.com/v3/ebrelsford.ho06j5h0/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a>'
      }).addTo(map);
      
        $.getJSON('http://maxfreedman.cartodb.com/api/v1/sql?q=SELECT * FROM district_borders&format=GeoJSON')
  
    // When it's done, add the results to the map
    .done(function (data) {
      L.geoJson(data, {
         style: function (feature) {
          var style = {
            fillOpacity: 0,
            stroke: true,
            color: '#000',
            weight: 2
          }
      return style;
        }
      }).addTo(map);   
   
    });
      /*
       * Create our time slider. We give it a format for the dates that it
       * will display underneath it. 'YYYY-MM-DD' means "year-month-day". If
       * you want to customize this see the moment.js documentation:
       *   http://momentjs.com/docs/#/displaying/
       */
        var slider = L.timelineSliderControl({
        start: new Date(1972, 0, 1),
        formatOutput: function(date){
          return moment(date).format("YYYY");
        }
      });
      map.addControl(slider);    
  slider.play();
  slider.pause();

      /*
       * Select our data from CartoDB. I'll reformat it here for clarity:
       *   SELECT *, date AS start, date + interval '1 days' AS end 
       *   FROM nypd_motor_vehicle_collisions_june_2015
       *   WHERE the_geom IS NOT NULL AND borough = ''
       *
       * This is selecting crashes (nypd_motor_vehicle_collisions_june_2015) where
       * the borough is empty. It is selecting all of the columns (*) and adding two
       * new columns:
       *  - The first is called 'start'. This is the date of the crash. You need
       *    a column named 'start' for Leaflet.timeline to work.
       *  - The second is called 'end'. This is when we want the crash to disappear
       *    from the map. We're adding 1 day(s) to the crashes so they stick around
       *    for a while. If you have a real end date you would probably want to use
       *    that.
       */
       var sql = "SELECT *, year_start AS start, year_end AS end FROM d16_schoolsdata_0424_merge WHERE the_geom IS NOT NULL";
      var url = 'http://maxfreedman.cartodb.com/api/v1/sql?' + $.param({
        format: 'geojson',
        q: sql
      });  
      
      var tractsSql = "SELECT *, year_start AS start, year_end AS end FROM ngis_d16tracts_7012_merge WHERE the_geom IS NOT NULL";
      var tractsUrl = 'http://maxfreedman.cartodb.com/api/v1/sql?' + $.param({
        format: 'geojson',
        q: tractsSql
      
    
      });
      
      /*
       * Actually get the data from CartoDB now that we have an SQL statement that works.
       */
      $.getJSON(url, function (data) {
        $.getJSON(tractsUrl, function (tractsData) {

          /*
           * Once the data loads, create an L.timeline. This replaces L.geoJson.
           */
          timeline = L.timeline(data, {
            onEachFeature: function (feature, layer) {
              layer.bindPopup('<strong><p>' + feature.properties.entityname + ' ' + '(' + feature.properties.dbn + ')' + '</p></strong><p>Year: ' + feature.properties.year + '</p><ul><li>Total Enrollment: ' + (feature.properties.enrnumtot === null ? 'no data' : feature.properties.enrnumtot) + '</li><li>African-American: ' + (feature.properties.enrnumafm === null ? 'no data' : feature.properties.enrnumafm) + ' ' + '(' + (feature.properties.enrpctafm_d === null ? ' -- ' : feature.properties.enrpctafm_d) + '%)' + '</li><li>Asian: ' + (feature.properties.enrnumasi === null ? 'no data' : feature.properties.enrnumasi) + ' ' + '(' + (feature.properties.enrpctasi_d === null ? ' -- ' : feature.properties.enrpctasi_d) + '%)' + '</li><li>Hispanic: ' + (feature.properties.enrnumhis === null ? 'no data' : feature.properties.enrnumhis) + ' ' + '(' + (feature.properties.enrpcthis_d === null ? ' -- ' : feature.properties.enrpcthis_d) + '%)' + '</li><li>White: ' + (feature.properties.enrnumwht === null ? 'no data' : feature.properties.enrnumwht) + ' ' + '(' + (feature.properties.enrpctwht_d === null ? ' -- ' : feature.properties.enrpctwht_d) + '%)' + '</li><li>Poverty: ' + (feature.properties.enrnumpov === null ? 'no data' : feature.properties.enrnumpov) + ' ' + '(' + (feature.properties.enrpctpov_d === null ? ' -- ' : feature.properties.enrpctpov_d) + '%)' + '</li><li>Free or Reduced Price Lunch: ' + (feature.properties.ccdenrnumfrl === null ? 'no data' : feature.properties.ccdenrnumfrl) + ' ' + '(' + (feature.properties.ccdenrpctfrl_d === null ? ' -- ' : feature.properties.ccdenrpctfrl_d) + '%)' + '</li></p>');
              
            },

            pointToLayer: function(data, latlng) {
              return L.circleMarker(latlng);
            },
            
            style: function (feature) {
              return getSchoolsStyle(feature);
            }
          });
          tractsTimeline = L.timeline(tractsData, {
            onEachFeature: function (feature, layer) {
              layer.bindPopup('<strong><p>' + feature.properties.name + '</p></strong><p>Year: ' + feature.properties.year + '</p><ul><li>Total Population: ' + feature.properties.numtot + '</li><li>African-American: ' + (feature.properties.numafm === null ? 'no data' : feature.properties.numafm) + ' ' + '(' + (feature.properties.pctafm_d === null ? ' -- ' : feature.properties.pctafm_d) + '%)' + '</li><li>Asian: ' + (feature.properties.numasi === null ? 'no data' : feature.properties.numasi) + ' ' + '(' + (feature.properties.pctasi_d === null ? ' -- ' : feature.properties.pctasi_d) + '%)' + '</li><li>Hispanic: ' + (feature.properties.numhis === null ? 'no data' : feature.properties.numhis) + ' ' + '(' + (feature.properties.pcthis_d === null ? ' -- ' : feature.properties.pcthis_d) + '%)' + '</li><li>White: ' + (feature.properties.numwht === null ? 'no data' : feature.properties.numwht) + ' ' + '(' + (feature.properties.pctwht_d === null ? ' -- ' : feature.properties.pctwht_d) + '%)' + '</li><li>Poverty: ' + (feature.properties.numpov === null ? 'no data' : feature.properties.numpov) + ' ' + '(' + (feature.properties.pctpov_d === null ? ' -- ' : feature.properties.pctpov_d) + '%)' + '</li><li>Under 18: ' + (feature.properties.num18 === null ? 'no data' : feature.properties.num18) + ' ' + '(' + (feature.properties.pct18_d === null ? ' -- ' : feature.properties.pct18_d) + '%)' + '</li></p>');
            },

            style: function(feature) {
              return getTractsStyle(feature);
            }
          });

          tractsTimeline.addTo(map);
          timeline.addTo(map);
          slider.addTimelines(timeline,tractsTimeline);

        });
      });

      $('.category').change(function () {
        // When the dropdown changes, set the style on each
        // census tract using our getTractsStyle function
        tractsTimeline.eachLayer(function (layer) {
          var feature = layer.feature;
          layer.setStyle(getTractsStyle(feature));
        });
      });
      $('.categorySchools').change(function () {
        // When the dropdown changes, set the style on each
        // census tract using our getTractsStyle function
        timeline.eachLayer(function (layer) {
          var feature = layer.feature;
          layer.setStyle(getSchoolsStyle(feature));
        });
      });

    });
  </script>

<style>
          .leaflet-left {
      width: 100%;
    }
      .leaflet-popup p {
    margin: 5px 20;
  }

    .category {
      position: absolute;
      right: 435px;
      top: 15px;
      z-index: 5000;
    }
     .categorySchools {
      position: absolute;
      right: 435px;
      top: 45px;
      z-index: 5000;
    }
</style>
  </head>
  <body>

    <div class="map" id="map"></div>
   <select class="category">
    <option value="pctafm">% african american</option>
    <option value="pctasi">% asian</option>
    <option value="pcthis">% hispanic</option>
    <option value="pctwht">% white</option>
    <option value="pctpov">% poverty</option>
    <option value="pct18">% under 18</option>
  </select>
    <select class="categorySchools">
    <option value="enrpctafm">% african american</option>
    <option value="enrpctasi">% asian</option>
    <option value="enrpcthis">% hispanic</option>
    <option value="enrpctwht">% white</option>
    <option value="enrpctpov">% poverty</option>
    <option value="ccdenrpctfrl">% FRPL</option>
  </select>
    <div class="sidepanel">
      <div class="wrapper">
        <div class="context subheader">
          <p>Map created by Max Freedman for <a href="http://brooklyndeep.org/">Brooklyn Deep</a></p>
        </div>
        <h1>Central Brooklyn School Mapping Project</h1>
        <h3>How to use</h3>
<ol><li>Select a demographic from one or both of the menus in the top right corner of the map.</li> 
          <li>Press play on the timeline, or use the arrows to skip from year to year.</li>
        <li>Click on a school or census tract to see more detailed information.</li></ol> 
          
          <h3>How to read</h3>
        <ul><li><strong>Shape: </strong>Each circle represents a public school in District 16.</li>
        <li><strong>Size: </strong>A school gets bigger and smaller as <em>enrollment</em> goes up and down.</li>
        <li><strong>Color: </strong>A school or census tract gets darker and lighter as the percentage of the selected <em>demographic</em> group in that school or census tract goes up and down. Gray indicates missing data.</li>
        <li><strong>Year: </strong>Each year displayed on the timeline refers to the school year <em>ending</em> in that year. For example, "2016" refers to the 2015-2016 school year.</li></ul>
        

        <!--Copy and paste the div below for creating content blocks-->


        <h3>Sources</h3>
          <h5><ul><li>New York City Municipal Library and Archives</li>
          <li>NYU Bobst Library</li>
             <li>National Center for Education Statistics</li>
              <li>NYU Research Alliance for NYC Schools</li>
              <li>NYC Department of Education</li>
              <li>National Historic Geographic Information System</li></h5>
              

        <div class="context footer">
          <p>Create your maps with ease using <a href="http://cartodb.com">CartoDB</a></p></p>
        </div>
      </div>
    </div>

  </body>
      </html>
